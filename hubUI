local UILibrary = {}
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local Player = Players.LocalPlayer

local theme = {
    background = Color3.fromRGB(10, 10, 10),
    surface = Color3.fromRGB(20, 20, 20),
    accent = Color3.fromRGB(0, 255, 136),
    accent2 = Color3.fromRGB(0, 200, 255),
    text = Color3.fromRGB(220, 220, 220),
    glow = Color3.fromRGB(0, 255, 136),
    slider = Color3.fromRGB(40, 40, 40),
    sliderFill = Color3.fromRGB(0, 255, 136),
    toggleOff = Color3.fromRGB(255, 50, 50),
    toggleOn = Color3.fromRGB(0, 255, 100),
    dropdown = Color3.fromRGB(30, 30, 30),
    dropdownHover = Color3.fromRGB(40, 40, 40),
}

local function createHoverEffect(button, originalColor)
    local hoverColor = originalColor:Lerp(Color3.fromRGB(255, 255, 255), 0.06)
    button.MouseEnter:Connect(function()
        button.BackgroundColor3 = hoverColor
    end)
    button.MouseLeave:Connect(function()
        button.BackgroundColor3 = originalColor
    end)
end

local function addCorner(instance, radius)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, radius or 4)
    corner.Parent = instance
    return corner
end

local Window = {}
Window.__index = Window

function UILibrary:CreateWindow(config)
    local self = setmetatable({}, Window)
    
    config = config or {}
    self.title = config.title or "UI Window"
    self.size = config.size or UDim2.new(0, 400, 0, 620)
    self.theme = config.theme or theme
    self.tabs = {}
    self.activeTab = nil
    
    local existingGui = Player.PlayerGui:FindFirstChild("AutoEncounterGUI")
    if existingGui then existingGui:Destroy() end
    
    self.screenGui = Instance.new("ScreenGui")
    self.screenGui.Name = "AutoEncounterGUI"
    self.screenGui.ResetOnSpawn = false
    self.screenGui.Parent = Player.PlayerGui
    
    self.frame = Instance.new("Frame")
    self.frame.Size = self.size
    self.frame.Position = UDim2.new(0.5, -self.size.X.Offset/2, 0.5, -self.size.Y.Offset/2)
    self.frame.BackgroundColor3 = self.theme.background
    self.frame.BorderSizePixel = 0
    self.frame.ClipsDescendants = true
    self.frame.Parent = self.screenGui
    
    local glow = Instance.new("Frame")
    glow.Size = UDim2.new(1, 10, 1, 10)
    glow.Position = UDim2.new(0, -5, 0, -5)
    glow.BackgroundColor3 = self.theme.glow
    glow.BackgroundTransparency = 0.8
    glow.BorderSizePixel = 0
    glow.ZIndex = -1
    glow.Parent = self.frame
    addCorner(glow, 6)
    
    self.innerBorder = Instance.new("Frame")
    self.innerBorder.Size = UDim2.new(1, -4, 1, -4)
    self.innerBorder.Position = UDim2.new(0, 2, 0, 2)
    self.innerBorder.BackgroundColor3 = self.theme.surface
    self.innerBorder.BorderSizePixel = 0
    self.innerBorder.Parent = self.frame
    addCorner(self.innerBorder, 4)
    
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, 35)
    titleBar.BackgroundColor3 = self.theme.surface
    titleBar.BorderSizePixel = 0
    titleBar.Parent = self.innerBorder
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -40, 1, 0)
    titleLabel.Position = UDim2.new(0, 10, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = self.title
    titleLabel.TextColor3 = self.theme.accent
    titleLabel.Font = Enum.Font.Code
    titleLabel.TextSize = 14
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.TextStrokeTransparency = 0.8
    titleLabel.TextStrokeColor3 = self.theme.glow
    titleLabel.Parent = titleBar
    
    local statusLight = Instance.new("Frame")
    statusLight.Size = UDim2.new(0, 8, 0, 8)
    statusLight.Position = UDim2.new(1, -15, 0.5, -4)
    statusLight.BackgroundColor3 = self.theme.accent2
    statusLight.BorderSizePixel = 0
    statusLight.Parent = titleBar
    self.statusLight = statusLight
    
    self.tabsRow = Instance.new("ScrollingFrame")
    self.tabsRow.Size = UDim2.new(1, 0, 0, 30)
    self.tabsRow.Position = UDim2.new(0, 0, 0, 35)
    self.tabsRow.BackgroundTransparency = 1
    self.tabsRow.ScrollBarThickness = 0
    self.tabsRow.CanvasSize = UDim2.new(0, 0, 0, 30)
    self.tabsRow.ScrollingDirection = Enum.ScrollingDirection.X
    self.tabsRow.Parent = self.innerBorder
    
    self.activeIndicator = Instance.new("Frame")
    self.activeIndicator.Size = UDim2.new(0, 83, 0, 3)
    self.activeIndicator.Position = UDim2.new(0, 6, 1, -3)
    self.activeIndicator.BackgroundColor3 = self.theme.accent2
    self.activeIndicator.BorderSizePixel = 0
    self.activeIndicator.ZIndex = 10
    self.activeIndicator.Parent = self.tabsRow
    addCorner(self.activeIndicator, 2)
    
    self:_makeDraggable(titleBar)
    
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed or UserInputService:GetFocusedTextBox() then return end
        if input.KeyCode == Enum.KeyCode.H then
            self.screenGui.Enabled = not self.screenGui.Enabled
        end
    end)
    
    return self
end

function Window:_makeDraggable(titleBar)
    local dragging, dragInput, dragStart, startPos
    
    titleBar.Active = true
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = self.frame.Position
            dragInput = input
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    titleBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if not dragging then return end
        if input == dragInput or input.UserInputType == Enum.UserInputType.Touch then
            local delta = input.Position - dragStart
            self.frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

function Window:_moveIndicatorTo(button, instant)
    local firstTabPos = 6
    local targetX = button.Position.X.Offset
    local targetW = button.Size.X.Offset - 12
    
    local targetPos = UDim2.new(0, targetX + 6, 1, -3)
    local targetSize = UDim2.new(0, targetW, 0, 3)
    
    if instant then
        self.activeIndicator.Position = targetPos
        self.activeIndicator.Size = targetSize
        return
    end
    
    local info = TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    TweenService:Create(self.activeIndicator, info, {Position = targetPos}):Play()
    TweenService:Create(self.activeIndicator, info, {Size = targetSize}):Play()
end

function Window:CreateTab(name)
    local tab = setmetatable({}, {__index = Tab})
    tab.name = name
    tab.window = self
    tab.theme = self.theme
    
    local tabCount = #self.tabs
    local xPos = 6 + (tabCount * 101)
    
    tab.button = Instance.new("TextButton")
    tab.button.Size = UDim2.new(0, 95, 1, -6)
    tab.button.Position = UDim2.new(0, xPos, 0, 3)
    tab.button.BackgroundColor3 = tabCount == 0 and self.theme.surface or self.theme.dropdown
    tab.button.BorderSizePixel = 0
    tab.button.Text = name
    tab.button.TextColor3 = tabCount == 0 and self.theme.accent2 or self.theme.text
    tab.button.Font = Enum.Font.Code
    tab.button.TextSize = 12
    tab.button.Parent = self.tabsRow
    addCorner(tab.button, 6)
    
    tab.content = Instance.new("ScrollingFrame")
    tab.content.Size = UDim2.new(1, -20, 1, -75)
    tab.content.Position = UDim2.new(0, 10, 0, 70)
    tab.content.BackgroundTransparency = 1
    tab.content.ScrollBarThickness = 0
    tab.content.Visible = (tabCount == 0)
    tab.content.Parent = self.innerBorder
    
    tab.layout = Instance.new("UIListLayout")
    tab.layout.SortOrder = Enum.SortOrder.LayoutOrder
    tab.layout.Padding = UDim.new(0, 6)
    tab.layout.Parent = tab.content
    
    tab.layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        local h = tab.layout.AbsoluteContentSize.Y + 18
        tab.content.CanvasSize = UDim2.new(0, 0, 0, math.max(h, 200))
    end)
    

    tab.button.MouseButton1Click:Connect(function()
        self:SelectTab(tab)
    end)
    
    table.insert(self.tabs, tab)
    
    self.tabsRow.CanvasSize = UDim2.new(0, xPos + 101, 0, 30)
    
    if tabCount == 0 then
        self.activeTab = tab
        self:_moveIndicatorTo(tab.button, true)
    end
    
    return tab
end

function Window:SelectTab(tab)
    for _, t in ipairs(self.tabs) do
        t.content.Visible = (t == tab)
        t.button.BackgroundColor3 = (t == tab) and self.theme.surface or self.theme.dropdown
        t.button.TextColor3 = (t == tab) and self.theme.accent2 or self.theme.text
    end
    self.activeTab = tab
    self:_moveIndicatorTo(tab.button)
end

Tab = {}
Tab.__index = Tab

function Tab:AddLabel(text, config)
    config = config or {}
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0, config.height or 20)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = config.color or self.theme.text
    label.Font = config.font or Enum.Font.Code
    label.TextSize = config.size or 12
    label.TextXAlignment = config.align or Enum.TextXAlignment.Left
    label.LayoutOrder = config.order or 999
    label.Parent = self.content
    return label
end

function Tab:AddButton(text, callback, config)
    config = config or {}
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(1, 0, 0, config.height or 45)
    button.BackgroundColor3 = config.color or self.theme.surface
    button.BorderColor3 = config.borderColor or self.theme.accent2
    button.BorderSizePixel = 2
    button.Text = text
    button.TextColor3 = config.textColor or self.theme.accent2
    button.Font = Enum.Font.Code
    button.TextSize = config.textSize or 14
    button.LayoutOrder = config.order or 999
    button.Parent = self.content
    addCorner(button, 4)
    createHoverEffect(button, button.BackgroundColor3)
    
    if callback then
        button.MouseButton1Click:Connect(callback)
    end
    
    return button
end

function Tab:AddToggle(text, default, callback, config)
    config = config or {}
    local row = Instance.new("Frame")
    row.Size = UDim2.new(1, 0, 0, config.height or 24)
    row.BackgroundTransparency = 1
    row.LayoutOrder = config.order or 999
    row.Parent = self.content
    
    local checkbox = Instance.new("TextButton")
    checkbox.Size = UDim2.new(0, 20, 0, 20)
    checkbox.Position = UDim2.new(0, 4, 0, 2)
    checkbox.BackgroundColor3 = default and self.theme.toggleOn or self.theme.dropdown
    checkbox.BorderColor3 = self.theme.accent
    checkbox.BorderSizePixel = 1
    checkbox.Text = default and "✓" or ""
    checkbox.TextColor3 = self.theme.background
    checkbox.Font = Enum.Font.Code
    checkbox.TextSize = 14
    checkbox.TextScaled = true
    checkbox.Parent = row
    addCorner(checkbox, 4)
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -28, 1, 0)
    label.Position = UDim2.new(0, 28, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = self.theme.text
    label.Font = Enum.Font.Code
    label.TextSize = 12
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = row
    
    local state = default or false
    
    checkbox.MouseButton1Click:Connect(function()
        state = not state
        checkbox.Text = state and "✓" or ""
        checkbox.BackgroundColor3 = state and self.theme.toggleOn or self.theme.dropdown
        if callback then callback(state) end
    end)
    
    return {checkbox = checkbox, label = label, row = row, GetState = function() return state end}
end

function Tab:AddTextBox(placeholder, config)
    config = config or {}
    local textbox = Instance.new("TextBox")
    textbox.Size = UDim2.new(1, 0, 0, config.height or 40)
    textbox.BackgroundColor3 = self.theme.surface
    textbox.BorderColor3 = self.theme.accent
    textbox.BorderSizePixel = 2
    textbox.Text = config.default or ""
    textbox.PlaceholderText = placeholder
    textbox.TextColor3 = self.theme.text
    textbox.Font = Enum.Font.Code
    textbox.TextSize = config.textSize or 12
    textbox.TextXAlignment = Enum.TextXAlignment.Left
    textbox.ClearTextOnFocus = false
    textbox.LayoutOrder = config.order or 999
    textbox.Parent = self.content
    addCorner(textbox, 4)
    
    textbox.Focused:Connect(function()
        textbox.BorderColor3 = self.theme.accent2
    end)
    textbox.FocusLost:Connect(function()
        textbox.BorderColor3 = self.theme.accent
        if config.callback then config.callback(textbox.Text) end
    end)
    
    return textbox
end

function Tab:AddSlider(text, min, max, default, callback, config)
    config = config or {}
    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, 0, 0, config.height or 60)
    container.BackgroundTransparency = 1
    container.LayoutOrder = config.order or 999
    container.Parent = self.content
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0, 20)
    label.BackgroundTransparency = 1
    label.Text = text .. ": " .. tostring(default)
    label.TextColor3 = self.theme.text
    label.Font = Enum.Font.Code
    label.TextSize = 12
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = container
    
    local sliderBg = Instance.new("Frame")
    sliderBg.Size = UDim2.new(1, 0, 0, 8)
    sliderBg.Position = UDim2.new(0, 0, 0, 25)
    sliderBg.BackgroundColor3 = self.theme.slider
    sliderBg.BorderSizePixel = 0
    sliderBg.Parent = container
    addCorner(sliderBg, 4)
    
    local sliderFill = Instance.new("Frame")
    local fillPercent = (default - min) / (max - min)
    sliderFill.Size = UDim2.new(fillPercent, 0, 1, 0)
    sliderFill.BackgroundColor3 = self.theme.sliderFill
    sliderFill.BorderSizePixel = 0
    sliderFill.Parent = sliderBg
    addCorner(sliderFill, 4)
    
    local currentValue = default
    
    local function updateSlider(value)
        value = math.clamp(value, 0, 1)
        local actualValue = min + (max - min) * value
        if config.round then
            actualValue = math.floor(actualValue + 0.5)
        end
        currentValue = actualValue
        sliderFill.Size = UDim2.new(value, 0, 1, 0)
        label.Text = text .. ": " .. tostring(actualValue)
        if callback then callback(actualValue) end
    end
    
    sliderBg.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            local function update()
                local mousePos = UserInputService:GetMouseLocation().X
                local sliderPos = sliderBg.AbsolutePosition.X
                local sliderSize = sliderBg.AbsoluteSize.X
                local value = (mousePos - sliderPos) / sliderSize
                updateSlider(value)
            end
            
            update()
            
            local moveConn, releaseConn
            moveConn = UserInputService.InputChanged:Connect(function(input2)
                if input2.UserInputType == Enum.UserInputType.MouseMovement then
                    update()
                end
            end)
            
            releaseConn = UserInputService.InputEnded:Connect(function(input2)
                if input2.UserInputType == Enum.UserInputType.MouseButton1 then
                    moveConn:Disconnect()
                    releaseConn:Disconnect()
                end
            end)
        end
    end)
    
    return {container = container, label = label, GetValue = function() return currentValue end, SetValue = updateSlider}
end

function Tab:AddDropdown(text, options, default, callback, config)
    config = config or {}
    local row = Instance.new("Frame")
    row.Size = UDim2.new(1, 0, 0, config.height or 26)
    row.BackgroundTransparency = 1
    row.LayoutOrder = config.order or 999
    row.Parent = self.content
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.5, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = self.theme.text
    label.Font = Enum.Font.Code
    label.TextSize = 12
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = row
    
    local dropdown = Instance.new("TextButton")
    dropdown.Size = UDim2.new(0.48, 0, 1, 0)
    dropdown.Position = UDim2.new(0.52, 0, 0, 0)
    dropdown.BackgroundColor3 = self.theme.dropdown
    dropdown.BorderColor3 = self.theme.accent
    dropdown.BorderSizePixel = 1
    dropdown.Text = default or options[1]
    dropdown.TextColor3 = self.theme.text
    dropdown.Font = Enum.Font.Code
    dropdown.TextSize = 12
    dropdown.Parent = row
    addCorner(dropdown, 4)
    
    local menu = Instance.new("Frame")
    menu.Size = UDim2.new(0.48, 0, 0, 0)
    menu.Position = UDim2.new(0.52, 0, 1, 6)
    menu.BackgroundColor3 = self.theme.surface
    menu.BorderColor3 = self.theme.accent2
    menu.BorderSizePixel = 1
    menu.Visible = false
    menu.Parent = row
    
    local menuLayout = Instance.new("UIListLayout")
    menuLayout.Padding = UDim.new(0, 4)
    menuLayout.Parent = menu
    
    for i, opt in ipairs(options) do
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(1, -10, 0, 24)
        btn.BackgroundColor3 = self.theme.surface
        btn.BorderSizePixel = 0
        btn.Text = opt
        btn.TextColor3 = self.theme.text
        btn.Font = Enum.Font.Code
        btn.TextSize = 12
        btn.Parent = menu
        
        btn.MouseButton1Click:Connect(function()
            dropdown.Text = opt
            menu.Visible = false
            if callback then callback(opt) end
        end)
    end
    
    menuLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        local h = menuLayout.AbsoluteContentSize.Y + 8
        menu.Size = UDim2.new(0.48, 0, 0, h)
    end)
    
    dropdown.MouseButton1Click:Connect(function()
        menu.Visible = not menu.Visible
    end)
    
    return {dropdown = dropdown, menu = menu, row = row}
end

function Tab:AddDivider(config)
    config = config or {}
    local divider = Instance.new("Frame")
    divider.Size = UDim2.new(1, 0, 0, 2)
    divider.BackgroundColor3 = config.color or self.theme.accent2
    divider.BorderSizePixel = 0
    divider.LayoutOrder = config.order or 999
    divider.Parent = self.content
    addCorner(divider, 1)
    return divider
end

function Tab:AddSpace(height)
    local space = Instance.new("Frame")
    space.Size = UDim2.new(1, 0, 0, height or 10)
    space.BackgroundTransparency = 1
    space.Parent = self.content
    return space
end

return UILibrary
